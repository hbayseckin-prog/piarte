{% extends "base.html" %}
{% block title %}Yoklama - Piarte{% endblock %}
{% block content %}
<div class="card">
	<h2 class="h1">Yoklama - Ders #{{ lesson.id }}</h2>
	<p style="color:var(--muted);margin-bottom:16px;">{{ lesson.lesson_date.strftime('%d.%m.%Y') if lesson.lesson_date else '-' }}</p>
	{% if error_message %}
	<div style="padding:12px;background:#fee2e2;border:1px solid #ef4444;border-radius:8px;margin-bottom:16px;color:#dc2626;">
		<strong>⚠️ Hata:</strong> {{ error_message }}
	</div>
	{% endif %}
	{% if request.session.get('attendance_duplicate_warning') %}
	<div id="duplicate-warning-dialog" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
		<div style="background:#fff;border-radius:12px;padding:24px;max-width:500px;width:100%;box-shadow:0 10px 25px rgba(0,0,0,0.2);">
			<h3 style="margin:0 0 16px 0;color:#0f172a;font-size:20px;font-weight:600;">⚠️ Uyarı</h3>
			<p style="margin:0 0 24px 0;color:#475569;font-size:16px;line-height:1.5;">
				{{ request.session.pop('attendance_duplicate_warning') }}
			</p>
			<button onclick="document.getElementById('duplicate-warning-dialog').style.display='none';" style="width:100%;padding:12px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:500;cursor:pointer;">Tamam</button>
		</div>
	</div>
	{% endif %}
	<form method="post" action="/lessons/{{ lesson.id }}/attendance/new" id="attendance-form">
		<div style="margin-bottom:16px;display:flex;flex-direction:column;gap:6px;">
			<label for="attendance_date" style="font-weight:600;color:#0f172a;">Yoklama Tarihi</label>
			<input
				type="date"
				id="attendance_date"
				{% if request.session.get('user') and request.session.get('user').get('role') == 'teacher' %}
				value=""
				readonly
				style="padding:10px;border:1px solid var(--border);border-radius:8px;background:#f1f5f9;color:#64748b;cursor:not-allowed;"
				{% else %}
				name="attendance_date"
				value="{{ attendance_date }}"
				style="padding:10px;border:1px solid var(--border);border-radius:8px;"
				{% endif %}
			/>
			{% if request.session.get('user') and request.session.get('user').get('role') == 'teacher' %}
			<input type="hidden" id="attendance_date_hidden" name="attendance_date" value="" />
			<small style="color:#64748b;">Normal yoklama için bugünün tarihi kullanılır. Telafi dersi için tarih seçebilirsiniz.</small>
			{% else %}
			<small style="color:#64748b;">Öğrenciler farklı günde geldiğinde tarihi değiştirerek yoklama alabilirsiniz.</small>
			{% endif %}
		</div>
		<div class="table-wrap">
			<table>
				<thead><tr><th>Öğrenci</th><th>Durum</th></tr></thead>
				<tbody>
				{% for item in students_with_status %}
				<tr style="{% if item.needs_payment %}background-color:#fee2e2;border-left:4px solid #ef4444;{% endif %}">
					<td>
						<strong style="{% if item.needs_payment %}color:#dc2626;{% endif %}">
							{{ item.student.first_name }} {{ item.student.last_name }}
							{% if item.needs_payment %}
							<span style="font-size:12px;color:#dc2626;margin-left:8px;">⚠️ Ödeme Gerekli</span>
							{% endif %}
						</strong>
					</td>
					<td>
						<select name="status_{{ item.student.id }}" style="width:100%;max-width:100%;">
							<option value="">-</option>
							<option value="PRESENT" {% if item.current_status == "PRESENT" %}selected{% endif %}>Geldi</option>
							<option value="EXCUSED_ABSENT" {% if item.current_status == "EXCUSED_ABSENT" %}selected{% endif %}>Haberli Gelmedi</option>
							<option value="TELAFI" {% if item.current_status == "TELAFI" or item.current_status == "LATE" %}selected{% endif %}>Telafi</option>
							<option value="UNEXCUSED_ABSENT" {% if item.current_status == "UNEXCUSED_ABSENT" %}selected{% endif %}>Habersiz Gelmedi</option>
						</select>
					</td>
				</tr>
				{% endfor %}
				</tbody>
			</table>
			<div class="mobile-card-view">
				{% for item in students_with_status %}
				<div class="mobile-card" style="{% if item.needs_payment %}background-color:#fee2e2;border-left:4px solid #ef4444;{% endif %}">
					<div class="mobile-card-row">
						<div class="mobile-card-label">Öğrenci</div>
						<div class="mobile-card-value">
							<strong style="{% if item.needs_payment %}color:#dc2626;{% endif %}">
								{{ item.student.first_name }} {{ item.student.last_name }}
								{% if item.needs_payment %}
								<span style="font-size:12px;color:#dc2626;margin-left:8px;display:block;margin-top:4px;">⚠️ Ödeme Gerekli</span>
								{% endif %}
							</strong>
						</div>
					</div>
					<div class="mobile-card-row">
						<div class="mobile-card-label">Durum</div>
						<div class="mobile-card-value">
							<select name="status_{{ item.student.id }}" style="width:100%;max-width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
								<option value="">-</option>
								<option value="PRESENT" {% if item.current_status == "PRESENT" %}selected{% endif %}>Geldi</option>
								<option value="EXCUSED_ABSENT" {% if item.current_status == "EXCUSED_ABSENT" %}selected{% endif %}>Haberli Gelmedi</option>
								<option value="TELAFI" {% if item.current_status == "TELAFI" or item.current_status == "LATE" %}selected{% endif %}>Telafi</option>
								<option value="UNEXCUSED_ABSENT" {% if item.current_status == "UNEXCUSED_ABSENT" %}selected{% endif %}>Habersiz Gelmedi</option>
							</select>
						</div>
					</div>
				</div>
				{% endfor %}
			</div>
		</div>
		<div style="margin-top:16px;">
			<button type="submit" style="width:100%;max-width:100%;margin:0 auto;display:block;min-height:48px;font-size:16px;">Kaydet</button>
		</div>
	</form>
</div>

{% if request.session.get('user') and request.session.get('user').get('role') == 'teacher' %}
<script>
	(function() {
		const attendanceDateInput = document.getElementById('attendance_date');
		const attendanceDateHidden = document.getElementById('attendance_date_hidden');
		const attendanceForm = document.getElementById('attendance-form');
		
		if (!attendanceDateInput || !attendanceDateHidden) return;
		
		// Bugünün tarihini hesapla ve set et
		const today = new Date();
		const todayStr = today.getFullYear() + '-' + 
			String(today.getMonth() + 1).padStart(2, '0') + '-' + 
			String(today.getDate()).padStart(2, '0');
		
		// Sayfa yüklendiğinde bugünün tarihini set et
		attendanceDateInput.value = todayStr;
		attendanceDateHidden.value = todayStr;
		
		// Tarih input değiştiğinde hidden input'u güncelle
		attendanceDateInput.addEventListener('change', function() {
			attendanceDateHidden.value = this.value;
		});
		
		// Tüm durum select'lerini bul (hem masaüstü hem mobil)
		const statusSelects = document.querySelectorAll('select[name^="status_"]');
		
		// Her select için change event listener ekle
		statusSelects.forEach(function(select) {
			select.addEventListener('change', function() {
				checkTelafiStatus();
			});
		});
		
		function checkTelafiStatus() {
			// Herhangi bir öğrenci için telafi seçilmiş mi kontrol et
			let hasTelafi = false;
			statusSelects.forEach(function(select) {
				if (select.value === 'TELAFI') {
					hasTelafi = true;
				}
			});
			
			// Telafi varsa tarih input'unu aktif et
			if (hasTelafi) {
				attendanceDateInput.removeAttribute('readonly');
				attendanceDateInput.style.background = '#fff';
				attendanceDateInput.style.color = '#0f172a';
				attendanceDateInput.style.cursor = 'text';
			} else {
				// Telafi yoksa bugünün tarihini set et ve readonly yap
				attendanceDateInput.value = todayStr;
				attendanceDateHidden.value = todayStr;
				attendanceDateInput.setAttribute('readonly', 'readonly');
				attendanceDateInput.style.background = '#f1f5f9';
				attendanceDateInput.style.color = '#64748b';
				attendanceDateInput.style.cursor = 'not-allowed';
			}
		}
		
		// Form submit edilmeden önce hidden input'u güncelle
		if (attendanceForm) {
			attendanceForm.addEventListener('submit', function(e) {
				attendanceDateHidden.value = attendanceDateInput.value;
			});
		}
		
		// Sayfa yüklendiğinde kontrol et
		checkTelafiStatus();
	})();
</script>
{% endif %}

{% endblock %}
