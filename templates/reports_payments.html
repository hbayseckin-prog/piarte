{% extends "base.html" %}
{% block title %}Ödeme Raporu - Piarte{% endblock %}
{% block content %}
<h2>Ödeme Raporu</h2>

{% if request.session.get('delete_payment_success') %}
<div style="padding:12px 16px;background:#10b981;color:#fff;border-radius:8px;margin-bottom:16px;">
    {{ request.session.pop('delete_payment_success') }}
</div>
{% endif %}
{% if request.session.get('delete_payment_error') %}
<div style="padding:12px 16px;background:#ef4444;color:#fff;border-radius:8px;margin-bottom:16px;">
    {{ request.session.pop('delete_payment_error') }}
</div>
{% endif %}

<form method="get" action="/ui/reports/payments" style="margin-bottom:12px">
	<label>Başlangıç</label>
	<input type="date" name="start" value="{{ start }}" />
	<label>Bitiş</label>
	<input type="date" name="end" value="{{ end }}" />
	<label>Kurs</label>
	<select name="course_id">
		<option value="">Hepsi</option>
		{% for c in courses %}
		<option value="{{ c.id }}" {% if course_id and c.id == course_id %}selected{% endif %}>{{ c.name }}</option>
		{% endfor %}
	</select>
	<label>Öğretmen</label>
	<select name="teacher_id">
		<option value="">Hepsi</option>
		{% for t in teachers %}
		<option value="{{ t.id }}" {% if teacher_id and t.id == teacher_id %}selected{% endif %}>{{ t.first_name }} {{ t.last_name }}</option>
		{% endfor %}
	</select>
	<button type="submit">Filtrele</button>
</form>

<div class="card">
	<strong>Toplam: {{ '%.2f'|format(total) }} TL</strong>
    <div style="margin-top:8px">
        <a href="/ui/reports/payments.csv?start={{ start }}&end={{ end }}&course_id={{ course_id }}&teacher_id={{ teacher_id }}">CSV indir</a>
        <button onclick="window.print()" style="margin-left:8px">Yazdır / PDF</button>
    </div>
</div>

<table>
	<thead>
		<tr>
			<th>Tarih</th>
			<th>Öğrenci</th>
			<th>Tutar</th>
			<th>Yöntem</th>
			<th>Not</th>
			{% if is_admin %}
			<th>İşlem</th>
			{% endif %}
		</tr>
	</thead>
	<tbody>
	{% for p in items %}
	<tr>
		<td>{{ p.payment_date }}</td>
		<td>{{ p.student.first_name }} {{ p.student.last_name }}</td>
		<td>{{ '%.2f'|format(p.amount_try) }}</td>
		<td>{{ p.method or '-' }}</td>
		<td>{{ p.note or '' }}</td>
		{% if is_admin %}
		<td>
			<div style="display:flex;gap:8px;align-items:center;">
				<a href="/payments/{{ p.id }}/edit?{% if start %}start={{ start }}&{% endif %}{% if end %}end={{ end }}&{% endif %}{% if course_id %}course_id={{ course_id }}&{% endif %}{% if teacher_id %}teacher_id={{ teacher_id }}{% endif %}" 
				   style="padding:6px 12px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:6px;font-size:12px;font-weight:500;display:inline-block;">Düzenle</a>
				<form method="post" action="/payments/{{ p.id }}/delete?{% if start %}start={{ start }}&{% endif %}{% if end %}end={{ end }}&{% endif %}{% if course_id %}course_id={{ course_id }}&{% endif %}{% if teacher_id %}teacher_id={{ teacher_id }}{% endif %}" 
					  style="display:inline;margin:0;" 
					  onsubmit="return confirm('Bu ödeme kaydını silmek istediğinizden emin misiniz?');">
					<button type="submit" style="padding:6px 12px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;">Sil</button>
				</form>
			</div>
		</td>
		{% endif %}
	</tr>
	{% else %}
	<tr><td colspan="{% if is_admin %}6{% else %}5{% endif %}">Kayıt bulunmuyor.</td></tr>
	{% endfor %}
	</tbody>
</table>
{% endblock %}


