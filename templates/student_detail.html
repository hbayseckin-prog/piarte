{% extends "base.html" %}
{% block title %}Öğrenci Detay - Piarte{% endblock %}
{% block content %}
<h2>{{ student.first_name }} {{ student.last_name }}</h2>
<div class="card">
	<h3>İletişim</h3>
	<div>Telefon: {{ student.phone_primary or '-' }}</div>
	<div>Adres: {{ student.address or '-' }}</div>
	<div>Veli: {{ student.parent_name or '-' }} ({{ student.parent_phone or '-' }})</div>
</div>

{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
<div class="card">
    <h3>Bilgileri Düzenle</h3>
    <form method="post" action="/students/{{ student.id }}/update" class="form-grid">
        <label>
            Ad
            <input type="text" name="first_name" value="{{ student.first_name }}" required />
        </label>
        <label>
            Soyad
            <input type="text" name="last_name" value="{{ student.last_name }}" required />
        </label>
        <label>
            Doğum Tarihi
            <input type="date" name="date_of_birth" value="{{ student.date_of_birth or '' }}" />
        </label>
        <label>
            Veli Adı
            <input type="text" name="parent_name" value="{{ student.parent_name or '' }}" />
        </label>
        <label>
            Veli Telefonu
            <input type="text" name="parent_phone" value="{{ student.parent_phone or '' }}" />
        </label>
        <label>
            Öğrenci Telefonu
            <input type="text" name="phone_primary" value="{{ student.phone_primary or '' }}" />
        </label>
        <label>
            İkinci Telefon
            <input type="text" name="phone_secondary" value="{{ student.phone_secondary or '' }}" />
        </label>
        <label>
            Adres
            <textarea name="address" rows="2">{{ student.address or '' }}</textarea>
        </label>
        <button type="submit">Kaydet</button>
    </form>
</div>
{% endif %}

<div class="card">
	<h3>Kayıtlı Kurslar</h3>
	<ul>
	{% for e in enrollments %}
		<li>{{ e.course.name }}</li>
	{% else %}
		<li>Henüz bir kursa kayıtlı değil.</li>
	{% endfor %}
	</ul>
	<p><a href="/enrollments/new">Kursa Kaydet</a></p>
</div>

<div class="card">
	<h3>Ödemeler</h3>
	<table>
		<thead><tr><th>Tarih</th><th>Tutar</th><th>Yöntem</th><th>Not</th></tr></thead>
		<tbody>
		{% for p in payments %}
		<tr>
			<td>{{ p.payment_date }}</td>
			<td>{{ '%.2f'| format(p.amount_try) }}</td>
			<td>{{ p.method or '-' }}</td>
			<td>{{ p.note or '' }}</td>
		</tr>
		{% else %}
		<tr><td colspan="4">Ödeme bulunmuyor.</td></tr>
		{% endfor %}
		</tbody>
	</table>
	<p><a href="/payments/new">Ödeme Gir</a></p>
</div>

<div class="card">
	<h3>Yoklamalar</h3>
	{% if attendances %}
	<div class="table-wrap">
		<table>
			<thead>
				<tr>
					<th>Ders Tarihi</th>
					<th>Saat</th>
					<th>Kurs</th>
					<th>Öğretmen</th>
					<th>Durum</th>
					<th>Yoklama Zamanı</th>
					<th>Not</th>
				</tr>
			</thead>
			<tbody>
				{% for entry in attendances %}
				<tr>
					<td>{{ entry.lesson.lesson_date.strftime('%d.%m.%Y') if entry.lesson and entry.lesson.lesson_date else '-' }}</td>
					<td>
						{% if entry.lesson and (entry.lesson.start_time or entry.lesson.end_time) %}
							{{ entry.lesson.start_time.strftime('%H:%M') if entry.lesson.start_time else '' }} - {{ entry.lesson.end_time.strftime('%H:%M') if entry.lesson.end_time else '' }}
						{% else %}-{% endif %}
					</td>
					<td><strong>{{ entry.course.name if entry.course else '-' }}</strong></td>
					<td>{% if entry.teacher %}{{ entry.teacher.first_name }} {{ entry.teacher.last_name }}{% else %}-{% endif %}</td>
					<td>
						{% if entry.attendance.status == 'PRESENT' %}
							<span style="padding:4px 8px;background:#10b981;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Geldi</span>
						{% elif entry.attendance.status == 'UNEXCUSED_ABSENT' %}
							<span style="padding:4px 8px;background:#ef4444;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Habersiz gelmedi</span>
						{% elif entry.attendance.status == 'EXCUSED_ABSENT' %}
							<span style="padding:4px 8px;background:#f97316;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Haberli gelmedi</span>
						{% elif entry.attendance.status == 'TELAFI' or entry.attendance.status == 'LATE' %}
							<span style="padding:4px 8px;background:#8b5cf6;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Telafi</span>
						{% else %}
							{{ entry.attendance.status }}
						{% endif %}
					</td>
					<td>{{ entry.attendance.marked_at.strftime('%d.%m.%Y %H:%M') if entry.attendance.marked_at else '-' }}</td>
					<td>{{ entry.attendance.note or '-' }}</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
		<div class="mobile-card-view">
			{% for entry in attendances %}
			<div class="mobile-card">
				<div class="mobile-card-row">
					<div class="mobile-card-label">Ders Tarihi</div>
					<div class="mobile-card-value">{{ entry.lesson.lesson_date.strftime('%d.%m.%Y') if entry.lesson and entry.lesson.lesson_date else '-' }}</div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">Saat</div>
					<div class="mobile-card-value">
						{% if entry.lesson and (entry.lesson.start_time or entry.lesson.end_time) %}
							{{ entry.lesson.start_time.strftime('%H:%M') if entry.lesson.start_time else '' }} - {{ entry.lesson.end_time.strftime('%H:%M') if entry.lesson.end_time else '' }}
						{% else %}-{% endif %}
					</div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">Kurs</div>
					<div class="mobile-card-value"><strong>{{ entry.course.name if entry.course else '-' }}</strong></div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">Öğretmen</div>
					<div class="mobile-card-value">{% if entry.teacher %}{{ entry.teacher.first_name }} {{ entry.teacher.last_name }}{% else %}-{% endif %}</div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">Durum</div>
					<div class="mobile-card-value">
						{% if entry.attendance.status == 'PRESENT' %}
							<span style="padding:4px 8px;background:#10b981;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Geldi</span>
						{% elif entry.attendance.status == 'UNEXCUSED_ABSENT' %}
							<span style="padding:4px 8px;background:#ef4444;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Habersiz gelmedi</span>
						{% elif entry.attendance.status == 'EXCUSED_ABSENT' %}
							<span style="padding:4px 8px;background:#f97316;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Haberli gelmedi</span>
						{% elif entry.attendance.status == 'TELAFI' or entry.attendance.status == 'LATE' %}
							<span style="padding:4px 8px;background:#8b5cf6;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Telafi</span>
						{% else %}
							{{ entry.attendance.status }}
						{% endif %}
					</div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">Yoklama Zamanı</div>
					<div class="mobile-card-value">{{ entry.attendance.marked_at.strftime('%d.%m.%Y %H:%M') if entry.attendance.marked_at else '-' }}</div>
				</div>
				{% if entry.attendance.note %}
				<div class="mobile-card-row">
					<div class="mobile-card-label">Not</div>
					<div class="mobile-card-value">{{ entry.attendance.note }}</div>
				</div>
				{% endif %}
			</div>
			{% endfor %}
		</div>
	</div>
	{% else %}
	<p style="color:#64748b;text-align:center;padding:20px;">Henüz yoklama kaydı bulunmuyor.</p>
	{% endif %}
</div>
{% endblock %}





