{% extends "base.html" %}
{% block title %}Yoklama - Piarte{% endblock %}
{% block content %}
<div class="card">
	<h2 class="h1">Yoklama - Ders #{{ lesson.id }}</h2>
	<p style="color:var(--muted);margin-bottom:16px;">{{ lesson.lesson_date.strftime('%d.%m.%Y') if lesson.lesson_date else '-' }}</p>
	{% if error_message %}
	<div style="padding:12px;background:#fee2e2;border:1px solid #ef4444;border-radius:8px;margin-bottom:16px;color:#dc2626;">
		<strong>âš ï¸ Hata:</strong> {{ error_message }}
	</div>
	{% endif %}
	{% if request.session.get('attendance_duplicate_warning') %}
	<div id="duplicate-warning-dialog" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
		<div style="background:#fff;border-radius:12px;padding:24px;max-width:500px;width:100%;box-shadow:0 10px 25px rgba(0,0,0,0.2);">
			<h3 style="margin:0 0 16px 0;color:#0f172a;font-size:20px;font-weight:600;">âš ï¸ UyarÄ±</h3>
			<p style="margin:0 0 24px 0;color:#475569;font-size:16px;line-height:1.5;">
				{{ request.session.pop('attendance_duplicate_warning') }}
			</p>
			<button onclick="document.getElementById('duplicate-warning-dialog').style.display='none';" style="width:100%;padding:12px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:500;cursor:pointer;">Tamam</button>
		</div>
	</div>
	{% endif %}
	<form method="post" action="/lessons/{{ lesson.id }}/attendance/new" id="attendance-form">
		<div style="margin-bottom:16px;display:flex;flex-direction:column;gap:6px;">
			<label for="attendance_date" style="font-weight:600;color:#0f172a;">Yoklama Tarihi</label>
			<input
				type="date"
				id="attendance_date"
				{% if request.session.get('user') and request.session.get('user').get('role') == 'teacher' %}
				value=""
				readonly
				style="padding:10px;border:1px solid var(--border);border-radius:8px;background:#f1f5f9;color:#64748b;cursor:not-allowed;"
				{% else %}
				name="attendance_date"
				value="{{ attendance_date }}"
				style="padding:10px;border:1px solid var(--border);border-radius:8px;"
				{% endif %}
			/>
			{% if request.session.get('user') and request.session.get('user').get('role') == 'teacher' %}
			<input type="hidden" id="attendance_date_hidden" name="attendance_date" value="" />
			<small style="color:#64748b;">Normal yoklama iÃ§in bugÃ¼nÃ¼n tarihi kullanÄ±lÄ±r. Telafi dersi iÃ§in tarih seÃ§ebilirsiniz.</small>
			{% else %}
			<small style="color:#64748b;">Ã–ÄŸrenciler farklÄ± gÃ¼nde geldiÄŸinde tarihi deÄŸiÅŸtirerek yoklama alabilirsiniz.</small>
			{% endif %}
		</div>
		<div class="table-wrap">
			<table>
				<thead><tr><th>Ã–ÄŸrenci</th><th>Durum</th></tr></thead>
				<tbody>
				{% for item in students_with_status %}
				<tr style="{% if item.needs_payment %}background-color:#fee2e2;border-left:4px solid #ef4444;{% endif %}">
					<td>
						<strong style="{% if item.needs_payment %}color:#dc2626;{% endif %}">
							{{ item.student.first_name }} {{ item.student.last_name }}
							{% if item.needs_payment %}
							<span style="font-size:12px;color:#dc2626;margin-left:8px;">âš ï¸ Ã–deme Gerekli</span>
							{% endif %}
						</strong>
					</td>
					<td>
						<select name="status_{{ item.student.id }}" style="width:100%;max-width:100%;">
							<option value="">-</option>
							<option value="PRESENT" {% if item.current_status == "PRESENT" %}selected{% endif %}>Geldi</option>
							<option value="EXCUSED_ABSENT" {% if item.current_status == "EXCUSED_ABSENT" %}selected{% endif %}>Haberli Gelmedi</option>
							<option value="TELAFI" {% if item.current_status == "TELAFI" or item.current_status == "LATE" %}selected{% endif %}>Telafi</option>
							<option value="UNEXCUSED_ABSENT" {% if item.current_status == "UNEXCUSED_ABSENT" %}selected{% endif %}>Habersiz Gelmedi</option>
						</select>
					</td>
				</tr>
				{% endfor %}
				</tbody>
			</table>
			<div class="mobile-card-view">
				{% for item in students_with_status %}
				<div class="mobile-card" style="{% if item.needs_payment %}background-color:#fee2e2;border-left:4px solid #ef4444;{% endif %}">
					<div class="mobile-card-row">
						<div class="mobile-card-label">Ã–ÄŸrenci</div>
						<div class="mobile-card-value">
							<strong style="{% if item.needs_payment %}color:#dc2626;{% endif %}">
								{{ item.student.first_name }} {{ item.student.last_name }}
								{% if item.needs_payment %}
								<span style="font-size:12px;color:#dc2626;margin-left:8px;display:block;margin-top:4px;">âš ï¸ Ã–deme Gerekli</span>
								{% endif %}
							</strong>
						</div>
					</div>
					<div class="mobile-card-row">
						<div class="mobile-card-label">Durum</div>
						<div class="mobile-card-value">
							<select name="status_{{ item.student.id }}" style="width:100%;max-width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
								<option value="">-</option>
								<option value="PRESENT" {% if item.current_status == "PRESENT" %}selected{% endif %}>Geldi</option>
								<option value="EXCUSED_ABSENT" {% if item.current_status == "EXCUSED_ABSENT" %}selected{% endif %}>Haberli Gelmedi</option>
								<option value="TELAFI" {% if item.current_status == "TELAFI" or item.current_status == "LATE" %}selected{% endif %}>Telafi</option>
								<option value="UNEXCUSED_ABSENT" {% if item.current_status == "UNEXCUSED_ABSENT" %}selected{% endif %}>Habersiz Gelmedi</option>
							</select>
						</div>
					</div>
				</div>
				{% endfor %}
			</div>
		</div>
		<div style="margin-top:16px;">
			<button type="submit" style="width:100%;max-width:100%;margin:0 auto;display:block;min-height:48px;font-size:16px;">Kaydet</button>
		</div>
	</form>
</div>

{% if request.session.get('user') and request.session.get('user').get('role') == 'teacher' and today_attendances_summary %}
<div class="card" style="margin-top:24px;">
	<h3 style="margin:0 0 16px 0;color:#0f172a;font-size:18px;font-weight:600;">ğŸ“… BugÃ¼n AlÄ±nan Yoklamalar Ã–zeti</h3>
	{% for summary in today_attendances_summary %}
	<div style="margin-bottom:20px;padding:16px;background:#f9fafb;border:1px solid var(--border);border-radius:8px;">
		<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
			<div>
				<h4 style="margin:0;color:#0f172a;font-size:16px;font-weight:600;">{{ summary.course_name }}</h4>
				{% if summary.lesson_time %}
				<p style="margin:4px 0 0 0;color:#64748b;font-size:14px;">Saat: {{ summary.lesson_time }}</p>
				{% endif %}
			</div>
			<a href="/lessons/{{ summary.lesson_id }}/attendance/new" style="padding:6px 12px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:6px;font-size:12px;font-weight:500;">Yoklama Al</a>
		</div>
		
		<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px;margin-bottom:12px;">
			<div style="padding:8px;background:#dcfce7;border-radius:6px;text-align:center;">
				<div style="font-size:20px;font-weight:700;color:#16a34a;">{{ summary.counts.PRESENT }}</div>
				<div style="font-size:12px;color:#15803d;margin-top:4px;">Geldi</div>
			</div>
			<div style="padding:8px;background:#fef3c7;border-radius:6px;text-align:center;">
				<div style="font-size:20px;font-weight:700;color:#d97706;">{{ summary.counts.EXCUSED_ABSENT }}</div>
				<div style="font-size:12px;color:#b45309;margin-top:4px;">Haberli Gelmedi</div>
			</div>
			<div style="padding:8px;background:#dbeafe;border-radius:6px;text-align:center;">
				<div style="font-size:20px;font-weight:700;color:#2563eb;">{{ summary.counts.TELAFI }}</div>
				<div style="font-size:12px;color:#1e40af;margin-top:4px;">Telafi</div>
			</div>
			<div style="padding:8px;background:#fee2e2;border-radius:6px;text-align:center;">
				<div style="font-size:20px;font-weight:700;color:#dc2626;">{{ summary.counts.UNEXCUSED_ABSENT }}</div>
				<div style="font-size:12px;color:#b91c1c;margin-top:4px;">Habersiz Gelmedi</div>
			</div>
		</div>
		
		<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
			<details style="cursor:pointer;">
				<summary style="font-size:14px;font-weight:600;color:#0f172a;user-select:none;">DetaylarÄ± GÃ¶ster ({{ summary.attendances|length }} Ã¶ÄŸrenci)</summary>
				<div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;">
					{% for att in summary.attendances %}
					<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fff;border-radius:6px;border:1px solid var(--border);">
						<span style="font-size:14px;color:#0f172a;font-weight:500;">{{ att.student_name }}</span>
						<div style="display:flex;gap:8px;align-items:center;">
							{% if att.status == 'PRESENT' %}
							<span style="padding:4px 8px;background:#dcfce7;color:#16a34a;border-radius:4px;font-size:12px;font-weight:500;">Geldi</span>
							{% elif att.status == 'EXCUSED_ABSENT' %}
							<span style="padding:4px 8px;background:#fef3c7;color:#d97706;border-radius:4px;font-size:12px;font-weight:500;">Haberli Gelmedi</span>
							{% elif att.status == 'TELAFI' %}
							<span style="padding:4px 8px;background:#dbeafe;color:#2563eb;border-radius:4px;font-size:12px;font-weight:500;">Telafi</span>
							{% elif att.status == 'UNEXCUSED_ABSENT' %}
							<span style="padding:4px 8px;background:#fee2e2;color:#dc2626;border-radius:4px;font-size:12px;font-weight:500;">Habersiz Gelmedi</span>
							{% endif %}
							{% if att.marked_at %}
							<span style="font-size:12px;color:#64748b;">{{ att.marked_at }}</span>
							{% endif %}
						</div>
					</div>
					{% endfor %}
				</div>
			</details>
		</div>
	</div>
	{% endfor %}
</div>
{% endif %}

{% if success_message %}
<div style="margin-top:16px;padding:12px 16px;background:#10b981;color:#fff;border-radius:8px;">
	âœ… {{ success_message }} yoklama kaydÄ± baÅŸarÄ±yla oluÅŸturuldu.
</div>
{% endif %}

{% if request.session.get('user') and request.session.get('user').get('role') == 'teacher' %}
<script>
	(function() {
		const attendanceDateInput = document.getElementById('attendance_date');
		const attendanceDateHidden = document.getElementById('attendance_date_hidden');
		const attendanceForm = document.getElementById('attendance-form');
		
		if (!attendanceDateInput || !attendanceDateHidden) return;
		
		// BugÃ¼nÃ¼n tarihini hesapla ve set et
		const today = new Date();
		const todayStr = today.getFullYear() + '-' + 
			String(today.getMonth() + 1).padStart(2, '0') + '-' + 
			String(today.getDate()).padStart(2, '0');
		
		// Sayfa yÃ¼klendiÄŸinde bugÃ¼nÃ¼n tarihini set et
		attendanceDateInput.value = todayStr;
		attendanceDateHidden.value = todayStr;
		
		// Tarih input deÄŸiÅŸtiÄŸinde hidden input'u gÃ¼ncelle
		attendanceDateInput.addEventListener('change', function() {
			attendanceDateHidden.value = this.value;
		});
		
		// TÃ¼m durum select'lerini bul (hem masaÃ¼stÃ¼ hem mobil)
		const statusSelects = document.querySelectorAll('select[name^="status_"]');
		
		// Her select iÃ§in change event listener ekle
		statusSelects.forEach(function(select) {
			select.addEventListener('change', function() {
				checkTelafiStatus();
			});
		});
		
		function checkTelafiStatus() {
			// Herhangi bir Ã¶ÄŸrenci iÃ§in telafi seÃ§ilmiÅŸ mi kontrol et
			let hasTelafi = false;
			statusSelects.forEach(function(select) {
				if (select.value === 'TELAFI') {
					hasTelafi = true;
				}
			});
			
			// Telafi varsa tarih input'unu aktif et
			if (hasTelafi) {
				attendanceDateInput.removeAttribute('readonly');
				attendanceDateInput.style.background = '#fff';
				attendanceDateInput.style.color = '#0f172a';
				attendanceDateInput.style.cursor = 'text';
			} else {
				// Telafi yoksa bugÃ¼nÃ¼n tarihini set et ve readonly yap
				attendanceDateInput.value = todayStr;
				attendanceDateHidden.value = todayStr;
				attendanceDateInput.setAttribute('readonly', 'readonly');
				attendanceDateInput.style.background = '#f1f5f9';
				attendanceDateInput.style.color = '#64748b';
				attendanceDateInput.style.cursor = 'not-allowed';
			}
		}
		
		// Form submit edilmeden Ã¶nce hidden input'u gÃ¼ncelle
		if (attendanceForm) {
			attendanceForm.addEventListener('submit', function(e) {
				attendanceDateHidden.value = attendanceDateInput.value;
			});
		}
		
		// Sayfa yÃ¼klendiÄŸinde kontrol et
		checkTelafiStatus();
	})();
</script>
{% endif %}

{% endblock %}
