{% extends "base.html" %}
{% block title %}Panel - Piarte{% endblock %}
{% block content %}
<h1>YÃ¶netim Paneli</h1>

{% if request.session.get('delete_attendance_success') %}
<div style="padding:12px 16px;background:#10b981;color:#fff;border-radius:8px;margin-bottom:16px;">
    {{ request.session.pop('delete_attendance_success') }}
</div>
{% endif %}
{% if request.session.get('delete_attendance_error') %}
<div style="padding:12px 16px;background:#ef4444;color:#fff;border-radius:8px;margin-bottom:16px;">
    {{ request.session.pop('delete_attendance_error') }}
</div>
{% endif %}

<div class="card">
	<h3>HÄ±zlÄ± Bilgiler</h3>
	<div>Toplam Kurs: {{ courses|length }}</div>
	<div>Toplam Ã–ÄŸrenci: {{ students|length }}</div>
	<div>Toplam Ã–ÄŸretmen: {{ teachers|length }}</div>
</div>

<div class="card">
    <h3 class="h2">HÄ±zlÄ± BaÄŸlantÄ±lar</h3>
	<div class="btn-group">
		<a href="/ui/students" style="padding:10px 16px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:500;text-align:center;display:inline-block;">Ã–ÄŸrenci Listesi</a>
		<a href="/students/new" style="padding:10px 16px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:500;text-align:center;display:inline-block;">Ã–ÄŸrenci Ekle</a>
		<a href="/payments/new" style="padding:10px 16px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:500;text-align:center;display:inline-block;">Ã–deme Gir</a>
		<a href="/lessons/new" style="padding:10px 16px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:500;text-align:center;display:inline-block;">Ders OluÅŸtur</a>
		<a href="/ui/teachers" style="padding:10px 16px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:500;text-align:center;display:inline-block;">Ã–ÄŸretmenler</a>
		<a href="/ui/reports/payments" style="padding:10px 16px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:500;text-align:center;display:inline-block;">Ã–deme Raporu</a>
	</div>
	{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
	<div style="margin-top:12px;">
		<strong style="color:#0f172a;font-size:16px;display:block;margin-bottom:8px;">Admin Ä°ÅŸlemleri:</strong>
		<a href="/ui/admin/users" style="padding:10px 16px;background:#10b981;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:500;display:inline-block;text-align:center;">KullanÄ±cÄ± YÃ¶netimi</a>
	</div>
	{% endif %}
</div>

<div class="card">
    <h3 class="h2">HÄ±zlÄ± Arama</h3>
	<form method="get" action="/ui/search">
		<input type="text" name="q" placeholder="Ã–ÄŸrenci, Ã¶ÄŸretmen veya kurs ara" required />
		<button type="submit">Ara</button>
	</form>
</div>

<div class="card">
    <h3 class="h2">Kurslar</h3>
    {% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
    <form method="post" action="/courses/new" class="form-row" style="margin-bottom:12px">
        <input name="name" placeholder="Kurs AdÄ±" required style="flex:2;" />
        <div class="btn-group" style="flex:1;">
            <button type="submit" style="flex:1;">Ekle</button>
            <button type="button" class="secondary" onclick="location.href='/ui/courses'" style="flex:1;">Liste</button>
        </div>
    </form>
    {% endif %}
	<div class="table-wrap">
		<table>
			<thead><tr><th>Ad</th><th>OluÅŸturma</th>{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}<th>Ä°ÅŸlemler</th>{% endif %}</tr></thead>
			<tbody>
			{% for c in courses %}
			<tr>
				<td><strong>{{ c.name }}</strong></td>
				<td>{{ c.created_at.date() }}</td>
				{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
				<td>
					<div class="btn-group" style="flex-wrap:nowrap;">
						<a href="/courses/{{ c.id }}/edit" style="padding:6px 12px; background:#0ea5e9; color:#fff; text-decoration:none; border-radius:8px; font-size:13px;white-space:nowrap;">DÃ¼zenle</a>
						<form method="post" action="/courses/{{ c.id }}/delete" style="display:inline;margin:0;" onsubmit="return confirm('Bu kursu silmek istediÄŸinizden emin misiniz?');">
							<button type="submit" style="padding:6px 12px; background:#ef4444; color:#fff; border:none; border-radius:8px; font-size:13px; cursor:pointer;white-space:nowrap;">Sil</button>
						</form>
					</div>
				</td>
				{% endif %}
			</tr>
			{% endfor %}
			</tbody>
		</table>
		<div class="mobile-card-view">
			{% for c in courses %}
			<div class="mobile-card">
				<div class="mobile-card-row">
					<div class="mobile-card-label">Kurs AdÄ±</div>
					<div class="mobile-card-value"><strong>{{ c.name }}</strong></div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">OluÅŸturma Tarihi</div>
					<div class="mobile-card-value">{{ c.created_at.date() }}</div>
				</div>
				{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
				<div class="mobile-card-row">
					<div class="mobile-card-label">Ä°ÅŸlemler</div>
					<div class="mobile-card-value">
						<div class="btn-group">
							<a href="/courses/{{ c.id }}/edit" style="padding:8px 12px; background:#0ea5e9; color:#fff; text-decoration:none; border-radius:8px; font-size:13px;display:inline-block;text-align:center;">DÃ¼zenle</a>
							<form method="post" action="/courses/{{ c.id }}/delete" style="display:inline;margin:0;" onsubmit="return confirm('Bu kursu silmek istediÄŸinizden emin misiniz?');">
								<button type="submit" style="padding:8px 12px; background:#ef4444; color:#fff; border:none; border-radius:8px; font-size:13px; cursor:pointer;">Sil</button>
							</form>
						</div>
					</div>
				</div>
				{% endif %}
			</div>
			{% endfor %}
		</div>
	</div>
</div>

<div class="card">
    <h3 class="h2">Ã–ÄŸretmenler</h3>
    {% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
    <form method="post" action="/teachers/new" class="form-row" style="margin-bottom:12px">
        <input name="first_name" placeholder="Ad" required />
        <input name="last_name" placeholder="Soyad" required />
        <input name="phone" placeholder="Telefon" />
        <input name="email" placeholder="E-posta" />
        <div class="btn-group" style="width:100%;">
            <button type="submit" style="flex:1;">Ekle</button>
            <button type="button" class="secondary" onclick="location.href='/ui/teachers'" style="flex:1;">Liste</button>
        </div>
    </form>
    {% endif %}
	<div class="table-wrap">
		<table>
			<thead><tr><th>Ad Soyad</th><th>Telefon</th>{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}<th>Ä°ÅŸlemler</th>{% endif %}</tr></thead>
			<tbody>
			{% for t in teachers %}
			<tr>
				<td><strong>{{ t.first_name }} {{ t.last_name }}</strong></td>
				<td>{{ t.phone or '-' }}</td>
				{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
				<td>
					<a href="/ui/teachers/{{ t.id }}" style="padding:6px 12px; background:#0ea5e9; color:#fff; text-decoration:none; border-radius:8px; font-size:13px;white-space:nowrap;">Detay & Ders ProgramÄ±</a>
				</td>
				{% endif %}
			</tr>
			{% endfor %}
			</tbody>
		</table>
		<div class="mobile-card-view">
			{% for t in teachers %}
			<div class="mobile-card">
				<div class="mobile-card-row">
					<div class="mobile-card-label">Ad Soyad</div>
					<div class="mobile-card-value"><strong>{{ t.first_name }} {{ t.last_name }}</strong></div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">Telefon</div>
					<div class="mobile-card-value">{{ t.phone or '-' }}</div>
				</div>
				{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
				<div class="mobile-card-row">
					<div class="mobile-card-label">Ä°ÅŸlemler</div>
					<div class="mobile-card-value">
						<a href="/ui/teachers/{{ t.id }}" style="padding:8px 12px; background:#0ea5e9; color:#fff; text-decoration:none; border-radius:8px; font-size:13px;display:block;text-align:center;">Detay & Ders ProgramÄ±</a>
					</div>
				</div>
				{% endif %}
			</div>
			{% endfor %}
		</div>
	</div>
</div>

<div class="card">
    <h3 class="h2">Personel</h3>
    {% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
    <form method="post" action="/ui/admin/users" class="form-row" style="margin-bottom:12px">
        <input name="username" placeholder="KullanÄ±cÄ± adÄ±" required />
        <input type="password" name="password" placeholder="Åifre" required />
        <input name="full_name" placeholder="Ad Soyad" />
        <input type="hidden" name="role" value="staff" />
        <div class="btn-group" style="width:100%;">
            <button type="submit" style="flex:1;">Ekle</button>
            <button type="button" class="secondary" onclick="location.href='/ui/admin/users'" style="flex:1;">TÃ¼m KullanÄ±cÄ±lar</button>
        </div>
    </form>
    {% endif %}
	<div class="table-wrap">
		<table>
			<thead><tr><th>KullanÄ±cÄ± AdÄ±</th><th>Ad Soyad</th><th>OluÅŸturma</th>{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}<th>Ä°ÅŸlemler</th>{% endif %}</tr></thead>
			<tbody>
			{% for staff in staff_users %}
			<tr>
				<td><strong>{{ staff.username }}</strong></td>
				<td>{{ staff.full_name or '-' }}</td>
				<td>{{ staff.created_at.strftime('%d.%m.%Y') if staff.created_at else '-' }}</td>
				{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
				<td>
					<a href="/ui/admin/users" style="padding:6px 12px; background:#0ea5e9; color:#fff; text-decoration:none; border-radius:8px; font-size:13px;white-space:nowrap;">YÃ¶net</a>
				</td>
				{% endif %}
			</tr>
			{% endfor %}
			{% if not staff_users %}
			<tr>
				<td colspan="{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}4{% else %}3{% endif %}" style="text-align:center;color:#64748b;">HenÃ¼z personel eklenmemiÅŸ</td>
			</tr>
			{% endif %}
			</tbody>
		</table>
		<div class="mobile-card-view">
			{% for staff in staff_users %}
			<div class="mobile-card">
				<div class="mobile-card-row">
					<div class="mobile-card-label">KullanÄ±cÄ± AdÄ±</div>
					<div class="mobile-card-value"><strong>{{ staff.username }}</strong></div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">Ad Soyad</div>
					<div class="mobile-card-value">{{ staff.full_name or '-' }}</div>
				</div>
				<div class="mobile-card-row">
					<div class="mobile-card-label">OluÅŸturma Tarihi</div>
					<div class="mobile-card-value">{{ staff.created_at.strftime('%d.%m.%Y') if staff.created_at else '-' }}</div>
				</div>
				{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
				<div class="mobile-card-row">
					<div class="mobile-card-label">Ä°ÅŸlemler</div>
					<div class="mobile-card-value">
						<a href="/ui/admin/users" style="padding:8px 12px; background:#0ea5e9; color:#fff; text-decoration:none; border-radius:8px; font-size:13px;display:block;text-align:center;">YÃ¶net</a>
					</div>
				</div>
				{% endif %}
			</div>
			{% endfor %}
			{% if not staff_users %}
			<div class="mobile-card">
				<div class="mobile-card-row">
					<div class="mobile-card-value" style="text-align:center;color:#64748b;">HenÃ¼z personel eklenmemiÅŸ</div>
				</div>
			</div>
			{% endif %}
		</div>
	</div>
</div>

<div class="card">
    <h3 class="h2">Yoklamalar</h3>
    <form method="get" action="/dashboard" class="form-row" style="margin-bottom:16px;padding:12px;background:#f9fafb;border-radius:12px;">
        <input type="date" name="start_date" value="{{ filters.start_date }}" placeholder="BaÅŸlangÄ±Ã§ Tarihi" />
        <input type="date" name="end_date" value="{{ filters.end_date }}" placeholder="BitiÅŸ Tarihi" />
        <select name="teacher_id">
            <option value="">TÃ¼m Ã–ÄŸretmenler</option>
            {% for t in teachers %}
            <option value="{{ t.id }}" {% if filters.teacher_id == t.id %}selected{% endif %}>{{ t.first_name }} {{ t.last_name }}</option>
            {% endfor %}
        </select>
        <select name="student_id">
            <option value="">TÃ¼m Ã–ÄŸrenciler</option>
            {% for s in students %}
            <option value="{{ s.id }}" {% if filters.student_id == s.id %}selected{% endif %}>{{ s.first_name }} {{ s.last_name }}</option>
            {% endfor %}
        </select>
        <select name="course_id">
            <option value="">TÃ¼m Kurslar</option>
            {% for c in courses %}
            <option value="{{ c.id }}" {% if filters.course_id == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
        <select name="status">
            <option value="">TÃ¼m Durumlar</option>
            <option value="PRESENT" {% if filters.status == 'PRESENT' %}selected{% endif %}>Geldi</option>
            <option value="EXCUSED_ABSENT" {% if filters.status == 'EXCUSED_ABSENT' %}selected{% endif %}>Haberli Gelmedi</option>
            <option value="TELAFI" {% if filters.status == 'TELAFI' or filters.status == 'LATE' %}selected{% endif %}>Telafi</option>
            <option value="UNEXCUSED_ABSENT" {% if filters.status == 'UNEXCUSED_ABSENT' %}selected{% endif %}>Habersiz Gelmedi</option>
        </select>
        <select name="order_by">
            <option value="marked_at_desc" {% if filters.order_by == 'marked_at_desc' %}selected{% endif %}>Yoklama ZamanÄ± (Yeni â†’ Eski)</option>
            <option value="marked_at_asc" {% if filters.order_by == 'marked_at_asc' %}selected{% endif %}>Yoklama ZamanÄ± (Eski â†’ Yeni)</option>
            <option value="lesson_date_desc" {% if filters.order_by == 'lesson_date_desc' %}selected{% endif %}>Yoklama Tarihi (Yeni â†’ Eski)</option>
            <option value="lesson_date_asc" {% if filters.order_by == 'lesson_date_asc' %}selected{% endif %}>Yoklama Tarihi (Eski â†’ Yeni)</option>
        </select>
        <div class="btn-group" style="width:100%;margin-top:8px;">
            <button type="submit" style="flex:1;">Filtrele</button>
            <a href="/dashboard" style="padding:12px 20px;background:#fff;color:#0f172a;border:1px solid var(--border);border-radius:8px;text-decoration:none;font-weight:500;display:inline-flex;align-items:center;justify-content:center;flex:1;">Temizle</a>
        </div>
    </form>
    {% if attendances %}
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Yoklama Tarihi</th>
                    <th>Saat</th>
                    <th>Kurs</th>
                    <th>Ã–ÄŸretmen</th>
                    <th>Ã–ÄŸrenci</th>
                    <th>Durum</th>
                    <th>Yoklama ZamanÄ±</th>
                    {% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
                    <th>Ä°ÅŸlem</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
            {% for entry in attendances %}
            <tr>
                <td>{{ entry.attendance.marked_at.strftime('%d.%m.%Y') if entry.attendance and entry.attendance.marked_at else '-' }}</td>
                <td>
                    {% if entry.lesson and (entry.lesson.start_time or entry.lesson.end_time) %}
                        {{ entry.lesson.start_time.strftime('%H:%M') if entry.lesson.start_time else '' }} - {{ entry.lesson.end_time.strftime('%H:%M') if entry.lesson.end_time else '' }}
                    {% else %}-{% endif %}
                </td>
                <td><strong>{{ entry.course.name if entry.course else '-' }}</strong></td>
                <td>{% if entry.teacher %}{{ entry.teacher.first_name }} {{ entry.teacher.last_name }}{% else %}-{% endif %}</td>
                <td><strong>{{ entry.student.first_name }} {{ entry.student.last_name }} {% if not entry.student %}(Ã–ÄŸrenci ID: {{ entry.attendance.student_id }}){% endif %}</strong></td>
                <td>
                    {% if entry.attendance.status == 'PRESENT' %}
                        <span style="padding:4px 8px;background:#10b981;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Geldi</span>
                    {% elif entry.attendance.status == 'UNEXCUSED_ABSENT' %}
                        <span style="padding:4px 8px;background:#ef4444;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Habersiz gelmedi</span>
                    {% elif entry.attendance.status == 'EXCUSED_ABSENT' %}
                        <span style="padding:4px 8px;background:#f97316;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Haberli gelmedi</span>
                    {% elif entry.attendance.status == 'TELAFI' or entry.attendance.status == 'LATE' %}
                        <span style="padding:4px 8px;background:#8b5cf6;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Telafi</span>
                    {% elif entry.attendance.status == 'ABSENT' %}
                        <span style="padding:4px 8px;background:#ef4444;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Yok</span>
                    {% else %}
                        {{ entry.attendance.status }}
                    {% endif %}
                </td>
                <td>{{ entry.attendance.marked_at.strftime('%d.%m.%Y %H:%M') if entry.attendance.marked_at else '-' }}</td>
                {% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
                <td>
                    <form method="post" action="/attendances/{{ entry.attendance.id }}/delete?{% if filters.teacher_id %}teacher_id={{ filters.teacher_id }}&{% endif %}{% if filters.student_id %}student_id={{ filters.student_id }}&{% endif %}{% if filters.course_id %}course_id={{ filters.course_id }}&{% endif %}{% if filters.status %}status={{ filters.status }}&{% endif %}{% if filters.start_date %}start_date={{ filters.start_date }}&{% endif %}{% if filters.end_date %}end_date={{ filters.end_date }}&{% endif %}{% if filters.order_by %}order_by={{ filters.order_by }}{% endif %}" 
                          style="display:inline;margin:0;" 
                          onsubmit="return confirm('Bu yoklama kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?');">
                        <button type="submit" style="padding:6px 12px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;">Sil</button>
                    </form>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <div class="mobile-card-view">
            {% for entry in attendances %}
            <div class="mobile-card">
                <div class="mobile-card-row">
                    <div class="mobile-card-label">Yoklama Tarihi</div>
                    <div class="mobile-card-value">{{ entry.attendance.marked_at.strftime('%d.%m.%Y') if entry.attendance and entry.attendance.marked_at else '-' }}</div>
                </div>
                <div class="mobile-card-row">
                    <div class="mobile-card-label">Saat</div>
                    <div class="mobile-card-value">
                        {% if entry.lesson and (entry.lesson.start_time or entry.lesson.end_time) %}
                            {{ entry.lesson.start_time.strftime('%H:%M') if entry.lesson.start_time else '' }} - {{ entry.lesson.end_time.strftime('%H:%M') if entry.lesson.end_time else '' }}
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="mobile-card-row">
                    <div class="mobile-card-label">Kurs</div>
                    <div class="mobile-card-value"><strong>{{ entry.course.name if entry.course else '-' }}</strong></div>
                </div>
                <div class="mobile-card-row">
                    <div class="mobile-card-label">Ã–ÄŸretmen</div>
                    <div class="mobile-card-value">{% if entry.teacher %}{{ entry.teacher.first_name }} {{ entry.teacher.last_name }}{% else %}-{% endif %}</div>
                </div>
                <div class="mobile-card-row">
                    <div class="mobile-card-label">Ã–ÄŸrenci</div>
                    <div class="mobile-card-value"><strong>{{ entry.student.first_name }} {{ entry.student.last_name }} {% if not entry.student %}(Ã–ÄŸrenci ID: {{ entry.attendance.student_id }}){% endif %}</strong></div>
                </div>
                <div class="mobile-card-row">
                    <div class="mobile-card-label">Durum</div>
                    <div class="mobile-card-value">
                        {% if entry.attendance.status == 'PRESENT' %}
                            <span style="padding:4px 8px;background:#10b981;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Geldi</span>
                        {% elif entry.attendance.status == 'UNEXCUSED_ABSENT' %}
                            <span style="padding:4px 8px;background:#ef4444;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Habersiz gelmedi</span>
                        {% elif entry.attendance.status == 'EXCUSED_ABSENT' %}
                            <span style="padding:4px 8px;background:#f97316;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Haberli gelmedi</span>
                        {% elif entry.attendance.status == 'TELAFI' or entry.attendance.status == 'LATE' %}
                            <span style="padding:4px 8px;background:#8b5cf6;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Telafi</span>
                        {% elif entry.attendance.status == 'ABSENT' %}
                            <span style="padding:4px 8px;background:#ef4444;color:#fff;border-radius:6px;font-size:12px;font-weight:500;">Yok</span>
                        {% else %}
                            {{ entry.attendance.status }}
                        {% endif %}
                    </div>
                </div>
                <div class="mobile-card-row">
                    <div class="mobile-card-label">Yoklama ZamanÄ±</div>
                    <div class="mobile-card-value">{{ entry.attendance.marked_at.strftime('%d.%m.%Y %H:%M') if entry.attendance.marked_at else '-' }}</div>
                </div>
                {% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
                <div class="mobile-card-row">
                    <div class="mobile-card-label">Ä°ÅŸlem</div>
                    <div class="mobile-card-value">
                        <form method="post" action="/attendances/{{ entry.attendance.id }}/delete?{% if filters.teacher_id %}teacher_id={{ filters.teacher_id }}&{% endif %}{% if filters.student_id %}student_id={{ filters.student_id }}&{% endif %}{% if filters.course_id %}course_id={{ filters.course_id }}&{% endif %}{% if filters.status %}status={{ filters.status }}&{% endif %}{% if filters.start_date %}start_date={{ filters.start_date }}&{% endif %}{% if filters.end_date %}end_date={{ filters.end_date }}&{% endif %}{% if filters.order_by %}order_by={{ filters.order_by }}{% endif %}" 
                              style="display:inline;margin:0;" 
                              onsubmit="return confirm('Bu yoklama kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?');">
                            <button type="submit" style="padding:8px 16px;background:#ef4444;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;width:100%;">Sil</button>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <p>HenÃ¼z yoklama kaydÄ± bulunmuyor.</p>
    {% endif %}
</div>

{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div>
            <h3 class="h2" style="margin:0;">Puantaj Tablosu</h3>
            <p style="color:var(--muted);margin-top:8px;margin-bottom:0;font-size:14px;">
        Ã–ÄŸretmenlerin Ã¶ÄŸrenciler iÃ§in aldÄ±ÄŸÄ± yoklamalar. Haberli gelmedi durumlarÄ± tabloya iÅŸlenmez. Filtreleme yaparak sonuÃ§larÄ± gÃ¶rÃ¼ntÃ¼leyebilirsiniz.
    </p>
        </div>
        <div>
            <a href="/dashboard/export/excel?{% if filters.teacher_id %}teacher_id={{ filters.teacher_id }}&{% endif %}{% if filters.student_id %}student_id={{ filters.student_id }}&{% endif %}{% if filters.course_id %}course_id={{ filters.course_id }}&{% endif %}{% if filters.status %}status={{ filters.status }}&{% endif %}{% if filters.start_date %}start_date={{ filters.start_date }}&{% endif %}{% if filters.end_date %}end_date={{ filters.end_date }}&{% endif %}" 
               style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:#10b981;color:#fff;border-radius:8px;text-decoration:none;font-weight:500;font-size:14px;transition:background 0.2s;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Excel'e Aktar
            </a>
        </div>
    </div>
    {% if attendance_report %}
        {% for teacher_report in attendance_report %}
        <div style="margin-bottom:32px;border:1px solid var(--border);border-radius:12px;padding:16px;background:#f9fafb;">
            <h4 style="margin:0 0 16px 0;color:#0f172a;font-size:18px;font-weight:600;padding-bottom:12px;border-bottom:2px solid var(--border);">
                {{ teacher_report.teacher.first_name }} {{ teacher_report.teacher.last_name }}
            </h4>
            {% if teacher_report.students %}
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Ã–ÄŸrenci</th>
                            <th>Geldi</th>
                            <th>Haberli Gelmedi</th>
                            <th>Telafi</th>
                            <th>Habersiz Gelmedi</th>
                            <th>Toplam Ders</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student_data in teacher_report.students %}
                        <tr>
                            <td><strong>{{ student_data.student.first_name }} {{ student_data.student.last_name }}</strong></td>
                            <td style="text-align:center;color:#10b981;font-weight:600;">{{ student_data.present }}</td>
                            <td style="text-align:center;color:#f97316;font-weight:600;">{{ student_data.excused_absent }}</td>
                            <td style="text-align:center;color:#8b5cf6;font-weight:600;">{{ student_data.telafi }}</td>
                            <td style="text-align:center;color:#ef4444;font-weight:600;">{{ student_data.unexcused_absent }}</td>
                            <td style="text-align:center;font-weight:600;">{{ student_data.total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="mobile-card-view">
                    {% for student_data in teacher_report.students %}
                    <div class="mobile-card">
                        <div class="mobile-card-row">
                            <div class="mobile-card-label">Ã–ÄŸrenci</div>
                            <div class="mobile-card-value"><strong>{{ student_data.student.first_name }} {{ student_data.student.last_name }}</strong></div>
                        </div>
                        <div class="mobile-card-row">
                            <div class="mobile-card-label">Geldi</div>
                            <div class="mobile-card-value" style="color:#10b981;font-weight:600;">{{ student_data.present }}</div>
                        </div>
                        <div class="mobile-card-row">
                            <div class="mobile-card-label">Haberli Gelmedi</div>
                            <div class="mobile-card-value" style="color:#f97316;font-weight:600;">{{ student_data.excused_absent }}</div>
                        </div>
                        <div class="mobile-card-row">
                            <div class="mobile-card-label">Telafi</div>
                            <div class="mobile-card-value" style="color:#8b5cf6;font-weight:600;">{{ student_data.telafi }}</div>
                        </div>
                        <div class="mobile-card-row">
                            <div class="mobile-card-label">Habersiz Gelmedi</div>
                            <div class="mobile-card-value" style="color:#ef4444;font-weight:600;">{{ student_data.unexcused_absent }}</div>
                        </div>
                        <div class="mobile-card-row">
                            <div class="mobile-card-label">Toplam Ders</div>
                            <div class="mobile-card-value" style="font-weight:600;">{{ student_data.total }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <p style="color:var(--muted);text-align:center;padding:16px;">Bu Ã¶ÄŸretmen iÃ§in henÃ¼z yoklama kaydÄ± bulunmuyor.</p>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
    <p style="color:var(--muted);text-align:center;padding:16px;">
        {% if filters.teacher_id or filters.student_id or filters.course_id or filters.start_date or filters.end_date %}
            SeÃ§ilen filtreler iÃ§in puantaj verisi bulunmuyor.
        {% else %}
            Puantaj verilerini gÃ¶rmek iÃ§in lÃ¼tfen filtreleme yapÄ±n.
        {% endif %}
    </p>
    {% endif %}
</div>
{% endif %}

{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
<div class="card">
	<h3 class="h2">HaftalÄ±k Ã–ÄŸretmen Ders ProgramlarÄ±</h3>
	{% if teachers_schedules %}
	<!-- Sekme ButonlarÄ± -->
	<div class="tabs-container" style="margin-bottom:16px;border-bottom:2px solid var(--border);display:flex;flex-wrap:wrap;gap:8px;">
		{% for schedule in teachers_schedules %}
		<button 
			class="tab-button" 
			data-teacher-id="{{ schedule.teacher.id }}"
			style="padding:10px 20px;background:#f1f5f9;color:#475569;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-weight:500;font-size:14px;transition:all 0.2s;{% if loop.first %}background:#0ea5e9;color:#fff;{% endif %}"
			onclick="showTeacherSchedule({{ schedule.teacher.id }})">
			{{ schedule.teacher.first_name }} {{ schedule.teacher.last_name }}
		</button>
		{% endfor %}
	</div>
	
	<!-- Ã–ÄŸretmen ProgramlarÄ± -->
	{% set weekdays = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'] %}
	{% set hours = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20] %}
	{% for schedule in teachers_schedules %}
	<div class="teacher-schedule" id="teacher-{{ schedule.teacher.id }}" style="display:{% if loop.first %}block{% else %}none{% endif %};">
		<h4 style="margin-bottom:12px;color:#0f172a;font-size:16px;font-weight:600;">
			{{ schedule.teacher.first_name }} {{ schedule.teacher.last_name }} - HaftalÄ±k Program
		</h4>
		{% if schedule.lessons %}
		<div style="overflow-x:auto;margin-top:12px;">
			<table style="width:100%;border-collapse:collapse;border:1px solid var(--border);background:#fff;">
				<thead>
					<tr>
						<th style="padding:8px;background:#f1f5f9;border:1px solid var(--border);text-align:left;font-size:12px;font-weight:600;min-width:60px;">Saat</th>
						{% for day_name in weekdays %}
						<th style="padding:8px;background:#f1f5f9;border:1px solid var(--border);text-align:center;font-size:12px;font-weight:600;min-width:120px;">{{ day_name }}</th>
						{% endfor %}
					</tr>
				</thead>
				<tbody>
					{% for hour in hours %}
					<tr>
						<td style="padding:8px;background:#f9fafb;border:1px solid var(--border);text-align:center;font-size:12px;font-weight:600;vertical-align:top;">{{ hour }}:00</td>
						{% for day_name in weekdays %}
						<td style="padding:4px;border:1px solid var(--border);vertical-align:top;min-height:60px;">
							{% for entry in schedule.lessons %}
								{% if entry.weekday == day_name %}
									{% set lesson_start_hour = entry.lesson.start_time.hour if entry.lesson.start_time else None %}
									{% if lesson_start_hour == hour %}
									<div style="padding:6px;background:#e0e7ff;border-radius:6px;margin-bottom:4px;font-size:11px;border-left:3px solid #6366f1;">
										<div style="font-weight:600;color:#0f172a;margin-bottom:2px;">{{ entry.lesson.course.name }}</div>
										<div style="color:#64748b;font-size:10px;margin-bottom:2px;">
											{% if entry.lesson.start_time or entry.lesson.end_time %}
												{{ entry.lesson.start_time.strftime('%H:%M') if entry.lesson.start_time else '' }} - {{ entry.lesson.end_time.strftime('%H:%M') if entry.lesson.end_time else '' }}
											{% endif %}
										</div>
										<div style="color:#64748b;font-size:10px;margin-bottom:2px;">{{ entry.current_lesson_date.strftime('%d.%m') if entry.current_lesson_date else entry.lesson.lesson_date.strftime('%d.%m') }}</div>
										{% if entry.students %}
										<div style="margin-top:4px;padding-top:4px;border-top:1px solid rgba(0,0,0,0.1);">
											{% for s in entry.students %}
												<div style="font-size:10px;color:#475569;">{{ s.first_name }} {{ s.last_name }}</div>
											{% endfor %}
										</div>
										{% endif %}
									</div>
									{% endif %}
								{% endif %}
							{% endfor %}
						</td>
						{% endfor %}
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<p style="color:#64748b;text-align:center;padding:20px;">Bu Ã¶ÄŸretmen iÃ§in henÃ¼z ders kaydÄ± bulunmuyor.</p>
		{% endif %}
	</div>
	{% endfor %}
	
	<style>
		.tab-button:hover {
			background:#e2e8f0 !important;
		}
		.tab-button.active {
			background:#0ea5e9 !important;
			color:#fff !important;
		}
		@media (max-width: 768px) {
			.tabs-container {
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
			}
			.tab-button {
				white-space: nowrap;
				font-size: 12px;
				padding: 8px 16px;
			}
		}
	</style>
	
	<script>
		function showTeacherSchedule(teacherId) {
			// TÃ¼m Ã¶ÄŸretmen programlarÄ±nÄ± gizle
			document.querySelectorAll('.teacher-schedule').forEach(function(el) {
				el.style.display = 'none';
			});
			
			// TÃ¼m sekme butonlarÄ±nÄ± pasif yap
			document.querySelectorAll('.tab-button').forEach(function(btn) {
				btn.style.background = '#f1f5f9';
				btn.style.color = '#475569';
			});
			
			// SeÃ§ilen Ã¶ÄŸretmen programÄ±nÄ± gÃ¶ster
			const scheduleEl = document.getElementById('teacher-' + teacherId);
			if (scheduleEl) {
				scheduleEl.style.display = 'block';
			}
			
			// SeÃ§ilen sekme butonunu aktif yap
			const activeBtn = document.querySelector('[data-teacher-id="' + teacherId + '"]');
			if (activeBtn) {
				activeBtn.style.background = '#0ea5e9';
				activeBtn.style.color = '#fff';
			}
		}
	</script>
	{% else %}
	<p style="color:#64748b;text-align:center;padding:20px;">HenÃ¼z Ã¶ÄŸretmen kaydÄ± bulunmuyor.</p>
    {% endif %}
</div>
{% endif %}

{% if request.session.get('user') and request.session.get('user').get('role') == 'admin' %}
<div class="card">
	<h3 class="h2">Ã–deme Gerekli Ã–ÄŸrenciler</h3>
	{% if students_needing_payment %}
	<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px;">
		{% for student in students_needing_payment %}
		<div 
			style="display:block;padding:12px;background:#fee2e2;border:1px solid #ef4444;border-radius:8px;color:#0f172a;transition:all 0.2s;border-left:4px solid #ef4444;"
			onmouseover="this.style.background='#fecaca';this.style.borderColor='#0ea5e9';"
			onmouseout="this.style.background='#fee2e2';this.style.borderColor='#ef4444';"
		>
			<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
				<div style="flex:1;min-width:200px;">
					<strong style="color:#dc2626;font-size:15px;">
						{{ student.first_name }} {{ student.last_name }}
						<span style="font-size:12px;color:#dc2626;margin-left:8px;">âš ï¸ Ã–deme Gerekli</span>
					</strong>
					{% if student.phone %}
					<div style="color:#64748b;font-size:13px;margin-top:4px;">ğŸ“ {{ student.phone }}</div>
					{% endif %}
					{% if student.email %}
					<div style="color:#64748b;font-size:13px;margin-top:2px;">âœ‰ï¸ {{ student.email }}</div>
					{% endif %}
				</div>
				<div style="display:flex;gap:8px;flex-wrap:wrap;">
					<a href="/ui/students/{{ student.id }}" style="padding:8px 16px;background:#0ea5e9;color:#fff;text-decoration:none;border-radius:6px;font-size:13px;font-weight:500;white-space:nowrap;display:inline-block;">Detay</a>
					<a href="/payments/new?student_id={{ student.id }}" style="padding:8px 16px;background:#10b981;color:#fff;text-decoration:none;border-radius:6px;font-size:13px;font-weight:500;white-space:nowrap;display:inline-block;">Ã–deme Al</a>
				</div>
			</div>
		</div>
		{% endfor %}
	</div>
	{% else %}
	<p style="color:#64748b;text-align:center;padding:20px;">Ã–deme gerekli Ã¶ÄŸrenci bulunmuyor.</p>
	{% endif %}
</div>
{% endif %}
{% endblock %}


